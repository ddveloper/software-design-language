<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ecommerce Checkout — SDL Diagram</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:         #0d1117;
  --surface:    #161b22;
  --surface-alt:#1c2128;
  --border:     #30363d;
  --text:       #e6edf3;
  --text-muted: #7d8590;
  --accent:     #58a6ff;
  --accent-text:#0d1117;
  --font:       'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif;
  --mono:       'IBM Plex Mono', 'Fira Code', monospace;
}
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); }
body { display: flex; flex-direction: column; overflow: hidden; }

/* ── Header ── */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; height: 52px; min-height: 52px;
  background: var(--surface); border-bottom: 1px solid var(--border);
  z-index: 10;
}
.header-title { font-size: 15px; font-weight: 600; letter-spacing: -0.01em; }
.header-meta  { font-size: 12px; color: var(--text-muted); font-family: var(--mono); }
.theme-badge  {
  font-size: 11px; font-family: var(--mono); padding: 3px 8px;
  background: var(--surface-alt); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text-muted);
}

/* ── Layout ── */
.app { display: flex; flex: 1; min-height: 0; }

/* ── Sidebar ── */
.sidebar {
  width: 260px; min-width: 260px;
  background: var(--surface); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-section { padding: 12px 16px 8px; border-bottom: 1px solid var(--border); }
.sidebar-section-title {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 8px;
}
.flow-list { overflow-y: auto; flex: 1; padding: 8px; }
.flow-item {
  display: flex; flex-direction: column; gap: 2px;
  padding: 8px 10px; border-radius: 6px; cursor: pointer;
  border: 1px solid transparent; margin-bottom: 4px;
  transition: all 0.15s;
}
.flow-item:hover  { background: var(--surface-alt); border-color: var(--border); }
.flow-item.active { background: var(--accent); border-color: var(--accent); }
.flow-item.active .flow-name, .flow-item.active .flow-trigger { color: var(--accent-text); }
.flow-name    { font-size: 13px; font-weight: 500; }
.flow-trigger { font-size: 10px; font-family: var(--mono); color: var(--text-muted); }

.stats { display: flex; gap: 16px; padding: 10px 16px; }
.stat  { display: flex; flex-direction: column; gap: 2px; }
.stat-value { font-size: 18px; font-weight: 600; font-family: var(--mono); color: var(--accent); }
.stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

/* ── Canvas ── */
.canvas-wrap {
  flex: 1; overflow: auto; position: relative;
  background: #0d1117;
}
.canvas-wrap svg { display: block; }

/* ── Detail panel ── */
.detail-panel {
  width: 280px; min-width: 280px;
  background: var(--surface); border-left: 1px solid var(--border);
  overflow-y: auto; display: none; flex-direction: column;
}
.detail-panel.visible { display: flex; }
.detail-header {
  padding: 14px 16px 10px; border-bottom: 1px solid var(--border);
  font-size: 13px; font-weight: 600;
}
.step-list { padding: 8px; }
.step-item {
  display: flex; gap: 10px; align-items: flex-start;
  padding: 8px 10px; border-radius: 6px; margin-bottom: 4px;
  border: 1px solid var(--border); transition: all 0.15s;
}
.step-item.highlighted { background: var(--surface-alt); border-color: var(--accent); }
.step-num {
  font-family: var(--mono); font-size: 11px; font-weight: 600;
  color: var(--accent); min-width: 28px; padding-top: 1px;
}
.step-content { flex: 1; }
.step-actor  { font-size: 12px; font-weight: 600; }
.step-action { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.step-via    { font-family: var(--mono); font-size: 10px; color: var(--accent); margin-top: 3px; }

/* ── Node tooltip ── */
.tooltip {
  position: fixed; display: none; z-index: 100;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 12px; max-width: 240px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  pointer-events: none;
}
.tooltip.visible { display: block; }
.tooltip-title   { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.tooltip-kind    { font-size: 10px; font-family: var(--mono); color: var(--accent); margin-bottom: 6px; }
.tooltip-resp    { font-size: 11px; color: var(--text-muted); line-height: 1.5; }
.tooltip-resp li { margin-left: 14px; }

/* ── Reset button ── */
.reset-btn {
  display: none; align-items: center; gap: 6px;
  margin: 8px 16px; padding: 6px 10px; border-radius: 5px;
  background: transparent; border: 1px solid var(--border);
  color: var(--text-muted); font-size: 11px; cursor: pointer;
  font-family: var(--font);
}
.reset-btn:hover { background: var(--surface-alt); }
.reset-btn.visible { display: flex; }
</style>
</head>
<body>

<header>
  <span class="header-title">Ecommerce Checkout</span>
  <span class="header-meta">13 nodes &middot; 16 edges &middot; 3 flows</span>
  <span class="theme-badge">Dark</span>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-title">System</div>
      <div class="stats">
        <div class="stat"><span class="stat-value">13</span><span class="stat-label">Nodes</span></div>
        <div class="stat"><span class="stat-value">16</span><span class="stat-label">Edges</span></div>
        <div class="stat"><span class="stat-value">3</span><span class="stat-label">Flows</span></div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Flows</div>
    </div>
    <button class="reset-btn" id="resetBtn" onclick="resetView()">&#x2715; Clear selection</button>
    <div class="flow-list" id="flowList"></div>
  </aside>

  <div class="canvas-wrap" id="canvasWrap">
    <svg xmlns="http://www.w3.org/2000/svg"
    width="1540" height="736"
    viewBox="0 0 1540 736">
    <defs>
    <filter id="shadow-dark" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.15)"/>
    </filter>
    <marker id="arrow-blue-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#58a6ff"/>
    </marker>
    <marker id="arrow-start-blue-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#58a6ff"/>
    </marker>
    <marker id="arrow-green-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#3fb950"/>
    </marker>
    <marker id="arrow-start-green-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#3fb950"/>
    </marker>
    <marker id="arrow-red-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#f85149"/>
    </marker>
    <marker id="arrow-start-red-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#f85149"/>
    </marker>
    <marker id="arrow-orange-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#e3804a"/>
    </marker>
    <marker id="arrow-start-orange-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#e3804a"/>
    </marker>
    <marker id="arrow-yellow-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#d29922"/>
    </marker>
    <marker id="arrow-start-yellow-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#d29922"/>
    </marker>
    <marker id="arrow-purple-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#bc8cff"/>
    </marker>
    <marker id="arrow-start-purple-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#bc8cff"/>
    </marker>
    <marker id="arrow-teal-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#2dd4bf"/>
    </marker>
    <marker id="arrow-start-teal-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#2dd4bf"/>
    </marker>
    <marker id="arrow-gray-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#7d8590"/>
    </marker>
    <marker id="arrow-start-gray-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#7d8590"/>
    </marker>
    <marker id="arrow-pink-dark" markerWidth="8" markerHeight="8"
      refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L0,8 L8,4 z" fill="#f778ba"/>
    </marker>
    <marker id="arrow-start-pink-dark" markerWidth="8" markerHeight="8"
      refX="1" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M8,0 L8,8 L0,4 z" fill="#f778ba"/>
    </marker></defs>
    <g opacity="0.5"><line x1="0" y1="0" x2="0" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="24" y1="0" x2="24" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="48" y1="0" x2="48" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="72" y1="0" x2="72" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="96" y1="0" x2="96" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="120" y1="0" x2="120" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="144" y1="0" x2="144" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="168" y1="0" x2="168" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="192" y1="0" x2="192" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="216" y1="0" x2="216" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="240" y1="0" x2="240" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="264" y1="0" x2="264" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="288" y1="0" x2="288" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="312" y1="0" x2="312" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="336" y1="0" x2="336" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="360" y1="0" x2="360" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="384" y1="0" x2="384" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="408" y1="0" x2="408" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="432" y1="0" x2="432" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="456" y1="0" x2="456" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="480" y1="0" x2="480" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="504" y1="0" x2="504" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="528" y1="0" x2="528" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="552" y1="0" x2="552" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="576" y1="0" x2="576" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="600" y1="0" x2="600" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="624" y1="0" x2="624" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="648" y1="0" x2="648" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="672" y1="0" x2="672" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="696" y1="0" x2="696" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="720" y1="0" x2="720" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="744" y1="0" x2="744" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="768" y1="0" x2="768" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="792" y1="0" x2="792" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="816" y1="0" x2="816" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="840" y1="0" x2="840" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="864" y1="0" x2="864" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="888" y1="0" x2="888" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="912" y1="0" x2="912" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="936" y1="0" x2="936" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="960" y1="0" x2="960" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="984" y1="0" x2="984" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1008" y1="0" x2="1008" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1032" y1="0" x2="1032" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1056" y1="0" x2="1056" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1080" y1="0" x2="1080" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1104" y1="0" x2="1104" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1128" y1="0" x2="1128" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1152" y1="0" x2="1152" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1176" y1="0" x2="1176" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1200" y1="0" x2="1200" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1224" y1="0" x2="1224" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1248" y1="0" x2="1248" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1272" y1="0" x2="1272" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1296" y1="0" x2="1296" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1320" y1="0" x2="1320" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1344" y1="0" x2="1344" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1368" y1="0" x2="1368" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1392" y1="0" x2="1392" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1416" y1="0" x2="1416" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1440" y1="0" x2="1440" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1464" y1="0" x2="1464" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1488" y1="0" x2="1488" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1512" y1="0" x2="1512" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="1536" y1="0" x2="1536" y2="736" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="0" x2="1540" y2="0" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="24" x2="1540" y2="24" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="48" x2="1540" y2="48" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="72" x2="1540" y2="72" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="96" x2="1540" y2="96" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="120" x2="1540" y2="120" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="144" x2="1540" y2="144" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="168" x2="1540" y2="168" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="192" x2="1540" y2="192" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="216" x2="1540" y2="216" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="240" x2="1540" y2="240" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="264" x2="1540" y2="264" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="288" x2="1540" y2="288" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="312" x2="1540" y2="312" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="336" x2="1540" y2="336" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="360" x2="1540" y2="360" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="384" x2="1540" y2="384" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="408" x2="1540" y2="408" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="432" x2="1540" y2="432" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="456" x2="1540" y2="456" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="480" x2="1540" y2="480" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="504" x2="1540" y2="504" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="528" x2="1540" y2="528" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="552" x2="1540" y2="552" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="576" x2="1540" y2="576" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="600" x2="1540" y2="600" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="624" x2="1540" y2="624" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="648" x2="1540" y2="648" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="672" x2="1540" y2="672" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="696" x2="1540" y2="696" stroke="#1c2128" stroke-width="0.5"/><line x1="0" y1="720" x2="1540" y2="720" stroke="#1c2128" stroke-width="0.5"/></g>
    <g id="edges"><g class="sdl-edge" data-id="user-to-frontend" data-source="end-user" data-target="web-frontend">
    <path d="M124,280 C164,280 20,92 60,92" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="92" y="178" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="frontend-to-gateway" data-source="web-frontend" data-target="api-gateway">
    <path d="M220,92 C260,92 260,100 300,100" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="260" y="88" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="gateway-session-cache" data-source="api-gateway" data-target="session-cache">
    <path d="M380,76 C668,76 732,435 1020,435" fill="none"
      stroke="#3fb950"
      stroke-width="1.5"
       marker-end="url(#arrow-green-dark)" marker-start="url(#arrow-start-green-dark)"
      opacity="0.7"/>
    <text x="700" y="247.5" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#3fb950">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">database</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="gateway-to-order" data-source="api-gateway" data-target="order-service">
    <path d="M380,100 C452,100 468,92 540,92" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="460" y="88" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="gateway-to-payment-webhook" data-source="api-gateway" data-target="payment-service">
    <path d="M380,124 C452,124 468,236.8 540,236.8" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" 
      opacity="0.7"/>
    <text x="460" y="172.4" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="order-to-inventory" data-source="order-service" data-target="inventory-service">
    <path d="M700,72.8 C772,72.8 468,420 540,420" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="620" y="238.4" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="order-to-payment" data-source="order-service" data-target="payment-service">
    <path d="M700,82.39999999999999 C772,82.39999999999999 468,275.2 540,275.2" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="620" y="170.79999999999998" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="order-to-db" data-source="order-service" data-target="order-db">
    <path d="M700,92 C844,92 876,95 1020,95" fill="none"
      stroke="#3fb950"
      stroke-width="1.5"
       marker-end="url(#arrow-green-dark)" marker-start="url(#arrow-start-green-dark)"
      opacity="0.7"/>
    <text x="860" y="85.5" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#3fb950">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">database</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="inventory-to-db" data-source="inventory-service" data-target="inventory-db">
    <path d="M700,400.8 C844,400.8 876,265 1020,265" fill="none"
      stroke="#3fb950"
      stroke-width="1.5"
       marker-end="url(#arrow-green-dark)" marker-start="url(#arrow-start-green-dark)"
      opacity="0.7"/>
    <text x="860" y="324.9" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#3fb950">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">database</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="payment-to-stripe" data-source="payment-service" data-target="stripe-api">
    <path d="M700,236.8 C952,236.8 1008,92 1260,92" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" marker-start="url(#arrow-start-blue-dark)"
      opacity="0.7"/>
    <text x="980" y="156.4" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="order-to-eventbus" data-source="order-service" data-target="event-bus">
    <path d="M700,101.6 C740,101.6 740,72.8 780,72.8" fill="none"
      stroke="#bc8cff"
      stroke-width="1.5"
      stroke-dasharray="8,4" marker-end="url(#arrow-purple-dark)" 
      opacity="0.7"/>
    <text x="740" y="79.19999999999999" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#bc8cff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">kafka</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="payment-to-eventbus" data-source="payment-service" data-target="event-bus">
    <path d="M700,275.2 C740,275.2 740,82.39999999999999 780,82.39999999999999" fill="none"
      stroke="#bc8cff"
      stroke-width="1.5"
      stroke-dasharray="8,4" marker-end="url(#arrow-purple-dark)" 
      opacity="0.7"/>
    <text x="740" y="170.79999999999998" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#bc8cff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">kafka</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="inventory-to-eventbus" data-source="inventory-service" data-target="event-bus">
    <path d="M700,439.2 C740,439.2 740,92 780,92" fill="none"
      stroke="#bc8cff"
      stroke-width="1.5"
      stroke-dasharray="8,4" marker-end="url(#arrow-purple-dark)" 
      opacity="0.7"/>
    <text x="740" y="257.6" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#bc8cff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">kafka</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="eventbus-to-order" data-source="event-bus" data-target="order-service">
    <path d="M780,101.6 C740,101.6 740,111.19999999999999 700,111.19999999999999" fill="none"
      stroke="#bc8cff"
      stroke-width="1.5"
      stroke-dasharray="8,4" marker-end="url(#arrow-purple-dark)" 
      opacity="0.7"/>
    <text x="740" y="98.39999999999999" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#bc8cff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">kafka</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="eventbus-to-notification" data-source="event-bus" data-target="notification-service">
    <path d="M780,111.19999999999999 C740,111.19999999999999 740,564.8 700,564.8" fill="none"
      stroke="#bc8cff"
      stroke-width="1.5"
      stroke-dasharray="8,4" marker-end="url(#arrow-purple-dark)" 
      opacity="0.7"/>
    <text x="740" y="330" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#bc8cff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">kafka</tspan>
      </text>
  </g>
<g class="sdl-edge" data-id="notification-to-sendgrid" data-source="notification-service" data-target="sendgrid">
    <path d="M700,603.1999999999999 C952,603.1999999999999 1008,256 1260,256" fill="none"
      stroke="#58a6ff"
      stroke-width="1.5"
       marker-end="url(#arrow-blue-dark)" 
      opacity="0.7"/>
    <text x="980" y="421.59999999999997" text-anchor="middle"
        font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="11"
        fill="#58a6ff">
        <tspan class="edge-label-bg" style="fill:rgba(22,27,34,0.92)">rest</tspan>
      </text>
  </g></g>
    <g id="nodes"><g class="sdl-node" data-id="end-user" data-kind="actor"
    style="cursor:pointer" title="End User">
    
      <circle cx="92" cy="254.08" r="14.08" fill="#1c2128" stroke="#7d8590" stroke-width="1.5"/>
      <path d="M72.8,320 Q72.8,273.79200000000003 92,273.79200000000003 Q111.2,273.79200000000003 111.2,320"
        fill="#1c2128" stroke="#7d8590" stroke-width="1.5"/>
    <g transform="translate(84, 256) scale(0.6666666666666666)">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" fill="none" stroke="#c9d1d9" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="92" y="336" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#c9d1d9" font-weight="600">End User</text><text x="92" y="350" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#c9d1d9" opacity="0.6">actor</text>
  </g>
<g class="sdl-node" data-id="web-frontend" data-kind="frontend"
    style="cursor:pointer" title="Web Storefront">
    <rect x="60" y="60" width="160" height="64" rx="8" ry="8"
      fill="#0f2a28" stroke="#2dd4bf" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(132, 74) scale(0.6666666666666666)">
    <path d="M20 3H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zM8 21h8M12 17v4" fill="none" stroke="#5eead4" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="140" y="102" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#5eead4" font-weight="600">Web Storefront</text><text x="140" y="116" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#5eead4" opacity="0.6">frontend</text>
  </g>
<g class="sdl-node" data-id="api-gateway" data-kind="gateway"
    style="cursor:pointer" title="API Gateway">
    <polygon points="340,60 380,100 340,140 300,100"
      fill="#1a2d4a" stroke="#58a6ff" stroke-width="1.5"/><g transform="translate(332, 82) scale(0.6666666666666666)">
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="#a5c8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="340" y="110" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#a5c8ff" font-weight="600">API Gateway</text><text x="340" y="124" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#a5c8ff" opacity="0.6">gateway</text>
  </g>
<g class="sdl-node" data-id="order-service" data-kind="microservice"
    style="cursor:pointer" title="Order Service">
    <rect x="540" y="60" width="160" height="64" rx="8" ry="8"
      fill="#1a2d4a" stroke="#58a6ff" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(612, 74) scale(0.6666666666666666)">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="#a5c8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="620" y="102" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#a5c8ff" font-weight="600">Order Service</text><text x="620" y="116" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#a5c8ff" opacity="0.6">microservice</text>
  </g>
<g class="sdl-node" data-id="inventory-service" data-kind="microservice"
    style="cursor:pointer" title="Inventory Service">
    <rect x="540" y="388" width="160" height="64" rx="8" ry="8"
      fill="#1a2d4a" stroke="#58a6ff" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(612, 402) scale(0.6666666666666666)">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="#a5c8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="620" y="430" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#a5c8ff" font-weight="600">Inventory Service</text><text x="620" y="444" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#a5c8ff" opacity="0.6">microservice</text>
  </g>
<g class="sdl-node" data-id="payment-service" data-kind="microservice"
    style="cursor:pointer" title="Payment Service">
    <rect x="540" y="224" width="160" height="64" rx="8" ry="8"
      fill="#1a2d4a" stroke="#58a6ff" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(612, 238) scale(0.6666666666666666)">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="#a5c8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="620" y="266" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#a5c8ff" font-weight="600">Payment Service</text><text x="620" y="280" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#a5c8ff" opacity="0.6">microservice</text>
  </g>
<g class="sdl-node" data-id="notification-service" data-kind="microservice"
    style="cursor:pointer" title="Notification Service">
    <rect x="540" y="552" width="160" height="64" rx="8" ry="8"
      fill="#1a2d4a" stroke="#58a6ff" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(612, 566) scale(0.6666666666666666)">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="#a5c8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="620" y="594" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#a5c8ff" font-weight="600">Notification Service</text><text x="620" y="608" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#a5c8ff" opacity="0.6">microservice</text>
  </g>
<g class="sdl-node" data-id="stripe-api" data-kind="external-api"
    style="cursor:pointer" title="Stripe">
    <rect x="1260" y="60" width="160" height="64" rx="8" ry="8"
      fill="#1c2128" stroke="#7d8590" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(1332, 74) scale(0.6666666666666666)">
    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="#c9d1d9" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="1340" y="102" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#c9d1d9" font-weight="600">Stripe</text><text x="1340" y="116" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#c9d1d9" opacity="0.6">external-api</text>
  </g>
<g class="sdl-node" data-id="order-db" data-kind="database"
    style="cursor:pointer" title="Orders Database">
    
      <ellipse cx="1090" cy="70" rx="70" ry="10" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5"/>
      <rect x="1020" y="70" width="140" height="60" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5" stroke-top="none"/>
      <line x1="1020" y1="70" x2="1020" y2="130" stroke="#3fb950" stroke-width="1.5"/>
      <line x1="1160" y1="70" x2="1160" y2="130" stroke="#3fb950" stroke-width="1.5"/>
      <ellipse cx="1090" cy="130" rx="70" ry="10" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5"/>
    <g transform="translate(1082, 77) scale(0.6666666666666666)">
    <path d="M12 2C6.48 2 2 4.24 2 7v10c0 2.76 4.48 5 10 5s10-2.24 10-5V7c0-2.76-4.48-5-10-5zm0 2c4.42 0 8 1.79 8 4s-3.58 4-8 4-8-1.79-8-4 3.58-4 8-4z" fill="none" stroke="#7ee787" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="1090" y="105" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#7ee787" font-weight="600">Orders Database</text><text x="1090" y="119" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#7ee787" opacity="0.6">database</text>
  </g>
<g class="sdl-node" data-id="inventory-db" data-kind="database"
    style="cursor:pointer" title="Inventory Database">
    
      <ellipse cx="1090" cy="240" rx="70" ry="10" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5"/>
      <rect x="1020" y="240" width="140" height="60" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5" stroke-top="none"/>
      <line x1="1020" y1="240" x2="1020" y2="300" stroke="#3fb950" stroke-width="1.5"/>
      <line x1="1160" y1="240" x2="1160" y2="300" stroke="#3fb950" stroke-width="1.5"/>
      <ellipse cx="1090" cy="300" rx="70" ry="10" fill="#1a3a2a" stroke="#3fb950" stroke-width="1.5"/>
    <g transform="translate(1082, 247) scale(0.6666666666666666)">
    <path d="M12 2C6.48 2 2 4.24 2 7v10c0 2.76 4.48 5 10 5s10-2.24 10-5V7c0-2.76-4.48-5-10-5zm0 2c4.42 0 8 1.79 8 4s-3.58 4-8 4-8-1.79-8-4 3.58-4 8-4z" fill="none" stroke="#7ee787" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="1090" y="275" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#7ee787" font-weight="600">Inventory Database</text><text x="1090" y="289" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#7ee787" opacity="0.6">database</text>
  </g>
<g class="sdl-node" data-id="session-cache" data-kind="cache"
    style="cursor:pointer" title="Session Cache">
    
      <ellipse cx="1090" cy="410" rx="70" ry="10" fill="#3a2210" stroke="#e3804a" stroke-width="1.5"/>
      <rect x="1020" y="410" width="140" height="60" fill="#3a2210" stroke="#e3804a" stroke-width="1.5" stroke-top="none"/>
      <line x1="1020" y1="410" x2="1020" y2="470" stroke="#e3804a" stroke-width="1.5"/>
      <line x1="1160" y1="410" x2="1160" y2="470" stroke="#e3804a" stroke-width="1.5"/>
      <ellipse cx="1090" cy="470" rx="70" ry="10" fill="#3a2210" stroke="#e3804a" stroke-width="1.5"/>
    <g transform="translate(1082, 417) scale(0.6666666666666666)">
    <path d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10zm0-18v8l4 2" fill="none" stroke="#ffa657" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="1090" y="445" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#ffa657" font-weight="600">Session Cache</text><text x="1090" y="459" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#ffa657" opacity="0.6">cache</text>
  </g>
<g class="sdl-node" data-id="event-bus" data-kind="message-broker"
    style="cursor:pointer" title="Event Bus">
    <rect x="780" y="60" width="160" height="64" rx="8" ry="8"
      fill="#2a1a3a" stroke="#bc8cff" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(852, 74) scale(0.6666666666666666)">
    <path d="M18 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM6 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM18 22a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98" fill="none" stroke="#d2a8ff" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="860" y="102" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#d2a8ff" font-weight="600">Event Bus</text><text x="860" y="116" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#d2a8ff" opacity="0.6">message-broker</text>
  </g>
<g class="sdl-node" data-id="sendgrid" data-kind="external-api"
    style="cursor:pointer" title="SendGrid">
    <rect x="1260" y="224" width="160" height="64" rx="8" ry="8"
      fill="#1c2128" stroke="#7d8590" stroke-width="1.5" filter="shadow-dark"/><g transform="translate(1332, 238) scale(0.6666666666666666)">
    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="none" stroke="#c9d1d9" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
  </g><text x="1340" y="266" text-anchor="middle"
    font-family="'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif" font-size="13"
    fill="#c9d1d9" font-weight="600">SendGrid</text><text x="1340" y="280" text-anchor="middle"
    font-family="'IBM Plex Mono', 'Fira Code', monospace" font-size="9"
    fill="#c9d1d9" opacity="0.6">external-api</text>
  </g></g>
  </svg>
  </div>

  <aside class="detail-panel" id="detailPanel">
    <div class="detail-header" id="detailTitle">Flow Steps</div>
    <div class="step-list" id="stepList"></div>
  </aside>
</div>

<div class="tooltip" id="tooltip">
  <div class="tooltip-title" id="ttTitle"></div>
  <div class="tooltip-kind"  id="ttKind"></div>
  <ul  class="tooltip-resp"  id="ttResp"></ul>
</div>

<script>
const flows    = [{"id":"place-order","label":"User Places an Order","description":"The primary checkout flow. Covers authentication, parallel cart validation and stock check, payment intent creation, order persistence, and async fulfilment kickoff. This flow ends when the order is persisted and a payment intent is handed to the client — fulfilment continues asynchronously in the 'order-fulfilment' flow.","trigger":"checkout-submit","steps":[{"id":"1.0","actor":"api-gateway","action":"verify JWT from request cookie","via":"gateway-session-cache","returns":"Authenticated user context (user ID, roles)","error":{"condition":"Token missing, expired, or invalid","handling":"Return 401 to client immediately. Do not forward request."}},{"id":"2.0","actor":"api-gateway","action":"route POST /orders to Order Service","via":"gateway-to-order","notes":"Gateway attaches verified user context as a signed internal header before forwarding."},{"id":"3.0","actor":"order-service","action":"validate order request structure and business rules","returns":"Validated order object (not yet persisted)","error":{"condition":"Missing fields, invalid address, cart is empty","handling":"Return 422 with field-level validation errors"},"notes":"No external calls yet. Pure in-process validation: required fields, non-empty cart, address format."},{"id":"4.a","actor":"order-service","action":"check stock availability for all line items","via":"order-to-inventory","parallel":true,"returns":"Stock availability map per line item","error":{"condition":"One or more items out of stock or below requested quantity","handling":"Return 409 with per-item availability details. Do not proceed to payment."}},{"id":"4.b","actor":"order-service","action":"create Stripe payment intent for order total","via":"order-to-payment","parallel":true,"returns":"Stripe PaymentIntent ID and client_secret","error":{"condition":"Stripe API timeout or error","handling":"Return 502. Do not persist order. Circuit breaker trips after 3 consecutive failures."},"notes":"Payment intent is created but NOT confirmed yet. Confirmation happens client-side or via webhook. order_id is embedded in PaymentIntent metadata for webhook correlation."},{"id":"5.0","actor":"order-service","action":"persist order with AWAITING_PAYMENT status","via":"order-to-db","returns":"Persisted order ID","error":{"condition":"Database write failure","handling":"Return 500. Void the payment intent created in step 4.b asynchronously.","goto":"5.0-compensate"}},{"id":"5.0-compensate","actor":"order-service","action":"void Stripe payment intent on DB failure","via":"order-to-payment","condition":"Only if step 5.0 failed","notes":"Compensation step to avoid orphaned payment intents. Best-effort — logged if it also fails."},{"id":"6.0","actor":"order-service","action":"emit order.created event","via":"order-to-eventbus","notes":"Downstream: inventory-service will reserve stock on receipt. This is fire-and-forget from the Order Service's perspective — it does not wait."},{"id":"7.0","actor":"api-gateway","action":"return order confirmation to client","via":"gateway-to-order","returns":"Order ID, AWAITING_PAYMENT status, and Stripe client_secret for client-side payment confirmation"}],"outcome":{"success":"Order persisted with AWAITING_PAYMENT status. Client receives order ID and Stripe client_secret to complete payment confirmation on the frontend.","side_effects":["event:order.created emitted to event bus","Inventory reservation triggered asynchronously","Stripe PaymentIntent created and awaiting client confirmation"]},"continues_async":[{"flow_ref":"order-fulfilment","via_event":"stripe-payment-success webhook","condition":"User completes client-side payment confirmation and Stripe reports success"},{"flow_ref":"payment-failure","via_event":"stripe-payment-failed webhook","condition":"User completes client-side payment confirmation and Stripe reports failure"}],"variants":[{"label":"Guest Checkout","flow_ref":"place-order-guest","condition":"User is not authenticated — email collected at checkout, account optionally created post-purchase"}],"tags":["critical-path","revenue","authenticated"]},{"id":"order-fulfilment","label":"Order Fulfilment After Payment","description":"The async continuation of the checkout flow. Triggered by Stripe's payment webhook after the user completes client-side payment confirmation. Transitions the order from AWAITING_PAYMENT to CONFIRMED and kicks off downstream fulfilment work.","trigger":"stripe-payment-success","steps":[{"id":"1.0","actor":"api-gateway","action":"receive POST /webhooks/stripe and forward to Payment Service","via":"gateway-to-payment-webhook","notes":"Gateway does NOT verify the Stripe signature — it passes the raw headers and body through. Verification is the responsibility of Payment Service which has the signing secret."},{"id":"2.0","actor":"payment-service","action":"verify Stripe-Signature HMAC header","returns":"Verified PaymentIntent object","error":{"condition":"Signature invalid or timestamp too old (replay attack)","handling":"Return 400 to Stripe. Log the incident. Do not process."}},{"id":"3.0","actor":"payment-service","action":"extract internal order ID from PaymentIntent metadata","returns":"Internal order ID","error":{"condition":"order_id missing from PaymentIntent metadata","handling":"Return 422. Alert on-call. This indicates a bug in payment intent creation."}},{"id":"4.0","actor":"payment-service","action":"emit payment.completed event with order ID","via":"payment-to-eventbus","notes":"Return 200 to Stripe immediately after emitting. Stripe will retry if it does not receive 200 within 30 seconds."},{"id":"5.0","actor":"order-service","action":"consume payment.completed from event bus","via":"eventbus-to-order","notes":"Order Service subscribes to payment.completed. This step is async — decoupled from the webhook response."},{"id":"6.0","actor":"order-service","action":"transition order status from AWAITING_PAYMENT to CONFIRMED","via":"order-to-db","error":{"condition":"Order not found or already in terminal state","handling":"Log and discard — idempotency guard. Likely a duplicate webhook delivery."}},{"id":"7.a","actor":"order-service","action":"emit order.confirmed event","via":"order-to-eventbus","parallel":true,"notes":"Consumed by notification-service to send confirmation email."},{"id":"7.b","actor":"inventory-service","action":"consume order.created and decrement stock","via":"eventbus-to-order","parallel":true,"notes":"inventory-service subscribes to order.created (emitted earlier in place-order flow). Shown here to illustrate the async parallelism across services. Decrement is idempotent via reservation ID.","condition":"If reservation was successfully made in response to order.created event"},{"id":"8.0","actor":"notification-service","action":"consume order.confirmed and send confirmation email via SendGrid","via":"notification-to-sendgrid","notes":"Notification Service subscribes to order.confirmed. Email contains order summary, estimated delivery, and support link."}],"outcome":{"success":"Order status is CONFIRMED. Customer receives confirmation email. Inventory decremented.","side_effects":["event:payment.completed emitted","event:order.confirmed emitted","Order status updated to CONFIRMED in orders DB","Inventory stock decremented","Confirmation email delivered via SendGrid"]},"continues_async":[{"flow_ref":"payment-failure","via_event":"stripe-payment-failed webhook","condition":"Only relevant as an alternative outcome — if payment fails instead of succeeding, this flow does not run"}],"tags":["critical-path","revenue","async"]},{"id":"payment-failure","label":"Payment Fails After Checkout","description":"Handles the case where Stripe reports a failed payment intent — card declined, fraud detected, or insufficient funds. Cancels the order and notifies the user.","trigger":"stripe-payment-failed","steps":[{"id":"1.0","actor":"api-gateway","action":"receive POST /webhooks/stripe and forward to Payment Service","via":"gateway-to-payment-webhook"},{"id":"2.0","actor":"payment-service","action":"verify Stripe-Signature and extract order ID","returns":"Verified failure reason and internal order ID","error":{"condition":"Signature invalid","handling":"Return 400. Log incident."}},{"id":"3.0","actor":"payment-service","action":"emit payment.failed event with order ID and failure reason","via":"payment-to-eventbus"},{"id":"4.0","actor":"order-service","action":"consume payment.failed and transition order to PAYMENT_FAILED","via":"eventbus-to-order","returns":"Updated order record"},{"id":"5.a","actor":"order-service","action":"emit order.cancelled event","via":"order-to-eventbus","parallel":true},{"id":"5.b","actor":"inventory-service","action":"release reserved stock for the cancelled order","via":"eventbus-to-order","parallel":true,"notes":"inventory-service subscribes to order.cancelled. Releases any reservation made during the place-order flow."},{"id":"6.0","actor":"notification-service","action":"consume payment.failed and send failure notification email","via":"notification-to-sendgrid","notes":"Email includes the failure reason and a direct link back to the checkout page to retry."}],"outcome":{"success":"Order cancelled. Stock reservation released. User notified with failure reason and retry link.","side_effects":["event:payment.failed emitted","event:order.cancelled emitted","Order status updated to PAYMENT_FAILED","Inventory reservation released","Payment failure email sent to customer"]},"tags":["error-path","async"]}];
const nodes    = [{"id":"end-user","label":"End User","kind":"actor"},{"id":"web-frontend","label":"Web Storefront","kind":"frontend","responsibilities":["Render product catalog and cart","Collect shipping and payment details","Display order confirmation"]},{"id":"api-gateway","label":"API Gateway","kind":"gateway","responsibilities":["Verify JWT on every inbound request","Rate limit by user and IP","Route requests to appropriate services","Terminate TLS"]},{"id":"order-service","label":"Order Service","kind":"microservice","responsibilities":["Validate and create orders","Coordinate with inventory and payment services","Persist order state","Emit order lifecycle events"]},{"id":"inventory-service","label":"Inventory Service","kind":"microservice","responsibilities":["Check stock availability","Reserve stock for pending orders","Release stock on cancellation","Decrement stock on fulfilment"]},{"id":"payment-service","label":"Payment Service","kind":"microservice","responsibilities":["Create Stripe payment intents","Expose webhook endpoint for Stripe callbacks","Verify Stripe webhook signatures","Emit internal payment events"]},{"id":"notification-service","label":"Notification Service","kind":"microservice","responsibilities":["Send order confirmation emails","Send payment failure notifications","Send shipping updates"]},{"id":"stripe-api","label":"Stripe","kind":"external-api"},{"id":"order-db","label":"Orders Database","kind":"database"},{"id":"inventory-db","label":"Inventory Database","kind":"database"},{"id":"session-cache","label":"Session Cache","kind":"cache"},{"id":"event-bus","label":"Event Bus","kind":"message-broker"},{"id":"sendgrid","label":"SendGrid","kind":"external-api"}];
const edges    = [{"id":"user-to-frontend","source":"end-user","target":"web-frontend","protocol":"rest","style":"sync"},{"id":"frontend-to-gateway","source":"web-frontend","target":"api-gateway","protocol":"rest","style":"sync"},{"id":"gateway-session-cache","source":"api-gateway","target":"session-cache","protocol":"database","style":"sync"},{"id":"gateway-to-order","source":"api-gateway","target":"order-service","protocol":"rest","style":"sync"},{"id":"gateway-to-payment-webhook","source":"api-gateway","target":"payment-service","protocol":"rest","style":"sync"},{"id":"order-to-inventory","source":"order-service","target":"inventory-service","protocol":"rest","style":"sync"},{"id":"order-to-payment","source":"order-service","target":"payment-service","protocol":"rest","style":"sync"},{"id":"order-to-db","source":"order-service","target":"order-db","protocol":"database","style":"sync"},{"id":"inventory-to-db","source":"inventory-service","target":"inventory-db","protocol":"database","style":"sync"},{"id":"payment-to-stripe","source":"payment-service","target":"stripe-api","protocol":"rest","style":"sync"},{"id":"order-to-eventbus","source":"order-service","target":"event-bus","protocol":"kafka","style":"async"},{"id":"payment-to-eventbus","source":"payment-service","target":"event-bus","protocol":"kafka","style":"async"},{"id":"inventory-to-eventbus","source":"inventory-service","target":"event-bus","protocol":"kafka","style":"async"},{"id":"eventbus-to-order","source":"event-bus","target":"order-service","protocol":"kafka","style":"async"},{"id":"eventbus-to-notification","source":"event-bus","target":"notification-service","protocol":"kafka","style":"async"},{"id":"notification-to-sendgrid","source":"notification-service","target":"sendgrid","protocol":"rest","style":"async"}];
const triggers = [{"id":"checkout-submit","label":"User Submits Checkout","kind":"user-interaction"},{"id":"stripe-payment-success","label":"Stripe: Payment Intent Succeeded","kind":"inbound-webhook"},{"id":"stripe-payment-failed","label":"Stripe: Payment Intent Failed","kind":"inbound-webhook"}];
const DIMMED   = 0.08;

let activeFlow = null;

// ── Build flow list ──────────────────────────────────────────────────────────
const flowList = document.getElementById("flowList");
flows.forEach(flow => {
  const trigger = triggers.find(t => t.id === flow.trigger);
  const el = document.createElement("div");
  el.className = "flow-item";
  el.dataset.flowId = flow.id;
  el.innerHTML = `
    <span class="flow-name">${flow.label}</span>
    <span class="flow-trigger">${trigger ? trigger.label : flow.trigger}</span>
  `;
  el.addEventListener("click", () => selectFlow(flow.id));
  flowList.appendChild(el);
});

// ── Flow selection ───────────────────────────────────────────────────────────
function selectFlow(flowId) {
  activeFlow = flowId;
  const flow = flows.find(f => f.id === flowId);
  if (!flow) return;

  // Update sidebar
  document.querySelectorAll(".flow-item").forEach(el => {
    el.classList.toggle("active", el.dataset.flowId === flowId);
  });
  document.getElementById("resetBtn").classList.add("visible");

  // Collect active node/edge ids from steps
  const activeNodes = new Set(flow.steps.map(s => s.actor).filter(Boolean));
  const activeEdges = new Set(flow.steps.map(s => s.via).filter(Boolean));

  // Dim everything
  document.querySelectorAll(".sdl-node").forEach(el => {
    el.style.opacity = activeNodes.has(el.dataset.id) ? "1" : String(DIMMED);
  });
  document.querySelectorAll(".sdl-edge").forEach(el => {
    el.style.opacity = activeEdges.has(el.dataset.id) ? "1" : String(DIMMED);
  });

  // Render step list
  const panel = document.getElementById("detailPanel");
  const stepList = document.getElementById("stepList");
  document.getElementById("detailTitle").textContent = flow.label;
  stepList.innerHTML = "";
  flow.steps.forEach(step => {
    const node = nodes.find(n => n.id === step.actor);
    const el = document.createElement("div");
    el.className = "step-item";
    el.innerHTML = `
      <span class="step-num">${step.id}</span>
      <div class="step-content">
        <div class="step-actor">${node ? node.label : step.actor}</div>
        <div class="step-action">${step.action}</div>
        ${step.via ? `<div class="step-via">via ${step.via}</div>` : ""}
      </div>
    `;
    el.addEventListener("mouseenter", () => highlightStep(step));
    el.addEventListener("mouseleave", () => selectFlow(flowId));
    stepList.appendChild(el);
  });
  panel.classList.add("visible");
}

function highlightStep(step) {
  document.querySelectorAll(".step-item").forEach(el => el.classList.remove("highlighted"));
  event.currentTarget.classList.add("highlighted");
  document.querySelectorAll(".sdl-node").forEach(el => {
    el.style.opacity = el.dataset.id === step.actor ? "1" : String(DIMMED);
  });
  document.querySelectorAll(".sdl-edge").forEach(el => {
    el.style.opacity = el.dataset.id === step.via ? "1" : String(DIMMED);
  });
}

function resetView() {
  activeFlow = null;
  document.querySelectorAll(".flow-item").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".sdl-node, .sdl-edge").forEach(el => el.style.opacity = "1");
  document.getElementById("detailPanel").classList.remove("visible");
  document.getElementById("resetBtn").classList.remove("visible");
}

// ── Node tooltips ─────────────────────────────────────────────────────────────
const tooltip = document.getElementById("tooltip");
document.querySelectorAll(".sdl-node").forEach(el => {
  el.addEventListener("mouseenter", (e) => {
    const node = nodes.find(n => n.id === el.dataset.id);
    if (!node) return;
    document.getElementById("ttTitle").textContent = node.label;
    document.getElementById("ttKind").textContent  = node.kind;
    const resp = document.getElementById("ttResp");
    resp.innerHTML = (node.responsibilities || []).map(r => `<li>${r}</li>`).join("");
    tooltip.classList.add("visible");
    positionTooltip(e);
  });
  el.addEventListener("mousemove", positionTooltip);
  el.addEventListener("mouseleave", () => tooltip.classList.remove("visible"));
});

function positionTooltip(e) {
  const pad = 16;
  let x = e.clientX + pad;
  let y = e.clientY + pad;
  if (x + 260 > window.innerWidth)  x = e.clientX - 260 - pad;
  if (y + 160 > window.innerHeight) y = e.clientY - 160 - pad;
  tooltip.style.left = x + "px";
  tooltip.style.top  = y + "px";
}

// ── Keyboard shortcut ─────────────────────────────────────────────────────────
document.addEventListener("keydown", e => { if (e.key === "Escape") resetView(); });
</script>
</body>
</html>