name: SDL Spec Compatibility

on:
  pull_request:
    paths:
      - 'spec/**'
      - 'stdlib/**'

jobs:
  # Runs only when /spec or /stdlib files are changed (enforced by paths filter above).
  # Flags breaking changes — does not auto-block them.
  # Breaking changes require spec maintainer sign-off via CODEOWNERS.
  spec-compatibility:
    name: Check spec compatibility
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to diff against base branch

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install diff tool
        run: npm install -g json-schema-diff-validator

      - name: Fetch base branch spec
        run: |
          git show origin/${{ github.base_ref }}:spec/node.schema.json    > /tmp/base-node.schema.json    2>/dev/null || echo '{}' > /tmp/base-node.schema.json
          git show origin/${{ github.base_ref }}:spec/edge.schema.json    > /tmp/base-edge.schema.json    2>/dev/null || echo '{}' > /tmp/base-edge.schema.json
          git show origin/${{ github.base_ref }}:spec/trigger.schema.json > /tmp/base-trigger.schema.json 2>/dev/null || echo '{}' > /tmp/base-trigger.schema.json
          git show origin/${{ github.base_ref }}:spec/flow.schema.json    > /tmp/base-flow.schema.json    2>/dev/null || echo '{}' > /tmp/base-flow.schema.json

      - name: Diff spec schemas
        run: |
          for schema in node edge trigger flow; do
            echo "--- Checking ${schema}.schema.json ---"
            json-schema-diff-validator \
              --before /tmp/base-${schema}.schema.json \
              --after  spec/${schema}.schema.json \
              --output json > /tmp/diff-${schema}.json 2>&1 || true
            cat /tmp/diff-${schema}.json
          done

      - name: Post compatibility summary as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const schemas = ['node', 'edge', 'trigger', 'flow'];
            let body = '## SDL Spec Compatibility Report\n\n';
            let hasBreaking = false;

            for (const schema of schemas) {
              try {
                const raw = fs.readFileSync(`/tmp/diff-${schema}.json`, 'utf8');
                const diff = JSON.parse(raw);
                if (diff.breaking && diff.breaking.length > 0) {
                  hasBreaking = true;
                  body += `### ⚠️ Breaking changes in \`${schema}.schema.json\`\n`;
                  diff.breaking.forEach(c => { body += `- ${c}\n`; });
                  body += '\n';
                } else {
                  body += `### ✅ \`${schema}.schema.json\` — no breaking changes\n\n`;
                }
              } catch (e) {
                body += `### ℹ️ \`${schema}.schema.json\` — no previous version to compare\n\n`;
              }
            }

            if (hasBreaking) {
              body += '---\n> **Breaking changes require spec maintainer sign-off.**\n> Existing SDL files declaring older versions will continue to validate correctly — but authors will need to migrate to use new required fields.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
