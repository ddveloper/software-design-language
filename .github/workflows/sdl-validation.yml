name: SDL Validation

on:
  pull_request:
    paths:
      - 'examples/**'
      - 'spec/**'
      - 'stdlib/**'

jobs:
  # ---------------------------------------------------------------
  # Job 1: Validate all examples against their declared sdlVersion
  # Runs on any PR that touches /examples
  # ---------------------------------------------------------------
  validate-examples:
    name: Validate SDL examples
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli/package.json

      - name: Install CLI dependencies
        run: npm install
        working-directory: cli

      - name: Run SDL validator
        # Run from repo root so relative paths to spec/ and stdlib/ resolve correctly.
        # Note: --versioned flag will be added to validate.js as part of v0.6.
        run: node cli/validate.js examples/

      - name: Write job summary
        if: always()
        run: |
          echo "## SDL Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == "success" ]; then
            echo "✅ All examples passed validation." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ One or more examples failed validation." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`node cli/validate.js examples/\` locally to see details." >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------
  # Job 2: Spec compatibility check
  # Runs only when /spec or /stdlib files are changed.
  # Flags breaking changes — does not auto-block them.
  # ---------------------------------------------------------------
  spec-compatibility:
    name: Check spec compatibility
    runs-on: ubuntu-latest
    if: >
      contains(toJson(github.event.pull_request.files), '"spec/') ||
      contains(toJson(github.event.pull_request.files), '"stdlib/')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to diff against base branch

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install diff tool
        run: npm install -g json-schema-diff-validator

      - name: Fetch base branch spec
        run: |
          git show origin/${{ github.base_ref }}:spec/node.schema.json    > /tmp/base-node.schema.json    2>/dev/null || echo '{}' > /tmp/base-node.schema.json
          git show origin/${{ github.base_ref }}:spec/edge.schema.json    > /tmp/base-edge.schema.json    2>/dev/null || echo '{}' > /tmp/base-edge.schema.json
          git show origin/${{ github.base_ref }}:spec/trigger.schema.json > /tmp/base-trigger.schema.json 2>/dev/null || echo '{}' > /tmp/base-trigger.schema.json
          git show origin/${{ github.base_ref }}:spec/flow.schema.json    > /tmp/base-flow.schema.json    2>/dev/null || echo '{}' > /tmp/base-flow.schema.json

      - name: Diff spec schemas
        id: diff
        run: |
          BREAKING=0
          for schema in node edge trigger flow; do
            echo "--- Checking ${schema}.schema.json ---"
            json-schema-diff-validator \
              --before /tmp/base-${schema}.schema.json \
              --after  spec/${schema}.schema.json \
              --output json > /tmp/diff-${schema}.json 2>&1 || BREAKING=1
            cat /tmp/diff-${schema}.json
          done
          echo "breaking=$BREAKING" >> $GITHUB_OUTPUT

      - name: Post compatibility summary as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const schemas = ['node', 'edge', 'trigger', 'flow'];
            let body = '## SDL Spec Compatibility Report\n\n';
            let hasBreaking = false;

            for (const schema of schemas) {
              try {
                const raw = fs.readFileSync(`/tmp/diff-${schema}.json`, 'utf8');
                const diff = JSON.parse(raw);
                if (diff.breaking && diff.breaking.length > 0) {
                  hasBreaking = true;
                  body += `### ⚠️ Breaking changes in \`${schema}.schema.json\`\n`;
                  diff.breaking.forEach(c => { body += `- ${c}\n`; });
                  body += '\n';
                } else {
                  body += `### ✅ \`${schema}.schema.json\` — no breaking changes\n\n`;
                }
              } catch (e) {
                body += `### ℹ️ \`${schema}.schema.json\` — no previous version to compare\n\n`;
              }
            }

            if (hasBreaking) {
              body += '---\n> **Breaking changes require spec maintainer sign-off.**\n> Existing SDL files declaring older versions will continue to validate correctly — but authors will need to migrate to use new required fields.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
